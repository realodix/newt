name: dusk

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          coverage: xdebug

      # https://github.com/marketplace/actions/setup-php-action#cache-composer-dependencies
      - name: Get composer cache directory
        id: composercache
        run: echo "::set-output name=dir::$(composer config cache-files-dir)"
      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: ${{ steps.composercache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: |
          composer -V
          composer install --no-interaction --ignore-platform-reqs

      - name: Prepare running Dusk
        run: |
            php artisan dusk:install
            cd ~
            # install Google Chrome
            sudo apt-get install libgbm1
            wget --quiet https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            sudo dpkg --install google-chrome-stable_current_amd64.deb
            cd -
            # Set the APP_URL in the .env.dusk file to the "artisan serve" url
            cp .env.example .env
            sudo sed -i 's~APP_URL=http://localhost~APP_URL="http://127.0.0.1:8000"~g' .env
            php artisan storage:link
            php artisan dusk:chrome-driver
            ./vendor/laravel/dusk/bin/chromedriver-linux &
            # Serve your application so Dusk can access it
            php artisan serve &

      - name: Run Dusk Tests
        env:
          APP_URL: "http://127.0.0.1:8000"
        run: php artisan dusk
